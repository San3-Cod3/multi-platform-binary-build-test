name: Build Python Binaries

on: [push, workflow_dispatch]

jobs:
  build-desktop:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      - run: echo "python3" > requirements.txt
      - run: pip install pyinstaller
      - run: mkdir -p spec
      - run: pyinstaller --onefile --specpath spec --name grok_farewell grok_farewell.py
      - name: Run Binary (Optional)
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            ./dist/grok_farewell.exe
          else
            ./dist/grok_farewell
          fi
      - run: echo "VERSION=$(git describe --tags --always || echo 'v1.0.0')" >> $GITHUB_ENV
      - run: echo "Grok Farewell v${{ env.VERSION }} - Built for ${{ runner.os }} on $(date)" > dist/README.txt
      - name: Create Checksum
        run: |
          python -c "import hashlib; f=open('./dist/grok_farewell${'.exe' if '${{ runner.os }}'=='Windows' else ''}','rb'); print(hashlib.sha256(f.read()).hexdigest())" > dist/CHECKSUM.txt
      - name: Zip Artifact
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            Compress-Archive -Path dist* -DestinationPath "grok-farewell-${{ runner.os }}-${{ env.VERSION }}.zip"
          else
            zip -r grok-farewell-${{ runner.os }}-${{ env.VERSION }}.zip dist/
          fi
        shell: bash
      - uses: actions/upload-artifact@v4
        with:
          name: grok-farewell-${{ runner.os }}-${{ env.VERSION }}
          path: grok-farewell-${{ runner.os }}-${{ env.VERSION }}.zip

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: android-pip-${{ hashFiles('requirements.txt') }}
      - run: echo "python3" > requirements.txt
      - run: pip install buildozer cython
      - name: Create buildozer.spec
        run: |
          buildozer init
          echo "[app]" > buildozer.spec
          echo "title = Grok Farewell" >> buildozer.spec
          echo "package.name = grokfarewell" >> buildozer.spec
          echo "source.dir = ." >> buildozer.spec
          echo "source.include_exts = py" >> buildozer.spec
          echo "source.main = grok_farewell.py" >> buildozer.spec
          echo "version = 1.0.0" >> buildozer.spec
          echo "requirements = python3" >> buildozer.spec
          echo "android.archs = arm64-v8a, armeabi-v7a" >> buildozer.spec
          echo "android.api = 34" >> buildozer.spec
      - name: Build Android APK
        run: buildozer android debug
      - name: Collect APK
        run: |
          mkdir -p android_dist
          cp bin/*.apk android_dist/ || echo "No APK built"
      - uses: actions/upload-artifact@v4
        with:
          name: grok-farewell-android
          path: android_dist/
